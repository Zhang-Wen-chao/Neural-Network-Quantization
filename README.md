# Neural-Network-Quantization
## [Introduction to Quantization on PyTorch](https://pytorch.org/blog/introduction-to-quantization-on-pytorch/)

### [Dynamic Quantization on BERT](https://pytorch.org/tutorials/intermediate/dynamic_quantization_bert_tutorial.html)
[è¿™ä¸ªåšå®¢](https://blog.csdn.net/zimiao552147572/article/details/105910915)å†™å¾—æŒºè¯¦ç»†ã€‚

åŸºæœ¬runæˆåŠŸäº†ã€‚ä¿å­˜åºåˆ—åŒ–æ–‡ä»¶é‡åˆ°äº†é—®é¢˜ï¼Œå‘é‚®ä»¶ç»™æœ‰åŒæ ·é—®é¢˜çš„äººäº†ã€‚
### [Dynamic Quantization on an LSTM Word Language Model](https://pytorch.org/tutorials/advanced/dynamic_quantization_tutorial.html)
åœ¨colabéƒ½è¿è¡Œä¸äº†ã€‚

wikitext-2æ•°æ®é›†ä¹Ÿä¸çŸ¥é“å»å“ªé‡Œä¸‹è½½å¸¦æœ‰validationçš„txtæ ¼å¼ã€‚
### [QUANTIZED TRANSFER LEARNING FOR COMPUTER VISION TUTORIAL](https://pytorch.org/tutorials/intermediate/quantized_transfer_learning_tutorial.html)
è¿™ä¸ªåœ¨colabå¯ä»¥éå¸¸é¡ºç•…åœ°è¿è¡Œã€‚
### [FX GRAPH MODE POST TRAINING STATIC QUANTIZATION](https://pytorch.org/tutorials/prototype/fx_graph_mode_ptq_static.html)
NameError: name 'qconfig_opt' is not defined

è¿è¡Œä¸äº†ï¼šæœ¬æ•™ç¨‹æè¿°äº†ä¸€ä¸ªåŸå‹åŠŸèƒ½ã€‚ åŸå‹åŠŸèƒ½é€šå¸¸ä¸ä½œä¸º PyPI æˆ– Conda ç­‰äºŒè¿›åˆ¶å‘è¡Œç‰ˆçš„ä¸€éƒ¨åˆ†æä¾›ï¼Œé™¤éæœ‰æ—¶åœ¨è¿è¡Œæ—¶æ ‡å¿—åé¢ï¼Œå¹¶ä¸”å¤„äºåé¦ˆå’Œæµ‹è¯•çš„æ—©æœŸé˜¶æ®µã€‚

ä½†imagenetçš„æ–‡ä»¶å¤¹å®Œæ•´äº†ã€‚
Neural-Network-Quantization/FX_GRAPH_MODE_POST_TRAINING_STATIC_QUANTIZATION/data/imagenet
### [FX GRAPH MODE POST TRAINING DYNAMIC QUANTIZATION](https://pytorch.org/tutorials/prototype/fx_graph_mode_ptq_dynamic.html)
runæˆåŠŸäº†ã€‚
## [PYTORCH 2 EXPORT POST TRAINING QUANTIZATION](https://pytorch.org/tutorials/prototype/pt2e_quant_ptq.html)
NameError: name 'qconfig_opt' is not defined

è¿è¡Œä¸äº†ï¼šæœ¬æ•™ç¨‹æè¿°äº†ä¸€ä¸ªåŸå‹åŠŸèƒ½ã€‚ åŸå‹åŠŸèƒ½é€šå¸¸ä¸ä½œä¸º PyPI æˆ– Conda ç­‰äºŒè¿›åˆ¶å‘è¡Œç‰ˆçš„ä¸€éƒ¨åˆ†æä¾›ï¼Œé™¤éæœ‰æ—¶åœ¨è¿è¡Œæ—¶æ ‡å¿—åé¢ï¼Œå¹¶ä¸”å¤„äºåé¦ˆå’Œæµ‹è¯•çš„æ—©æœŸé˜¶æ®µã€‚
### [PYTORCH 2 EXPORT QUANTIZATION-AWARE TRAINING (QAT)](https://pytorch.org/tutorials/prototype/pt2e_quant_qat.html)
NameError: name 'qconfig_opt' is not defined

è¿è¡Œä¸äº†ï¼šæœ¬æ•™ç¨‹æè¿°äº†ä¸€ä¸ªåŸå‹åŠŸèƒ½ã€‚ åŸå‹åŠŸèƒ½é€šå¸¸ä¸ä½œä¸º PyPI æˆ– Conda ç­‰äºŒè¿›åˆ¶å‘è¡Œç‰ˆçš„ä¸€éƒ¨åˆ†æä¾›ï¼Œé™¤éæœ‰æ—¶åœ¨è¿è¡Œæ—¶æ ‡å¿—åé¢ï¼Œå¹¶ä¸”å¤„äºåé¦ˆå’Œæµ‹è¯•çš„æ—©æœŸé˜¶æ®µã€‚
# æ¯•è®¾è¿›åº¦
è·Ÿç€è¿½ä¹å¤§å…µçš„è§†é¢‘ï¼Œçœ‹å®Œäº†p13ã€‚è¿™ä¸ªç³»åˆ—çš„è§†é¢‘ï¼Œé‡åœ¨åˆ†æé‡åŒ–æ–¹æ³•ã€‚ä¸åœ¨å®ç°æŸä¸ªç®—æ³•ã€‚

æˆ‘æ„Ÿè§‰æˆ‘å¥½åƒæé”™äº†é‡ç‚¹ï¼Œæˆ‘çš„æ¯•è®¾åå­—å¾ˆå¥½å•Šï¼Œç®¡å®ƒä»€ä¹ˆå‘¢ï¼Œæˆ‘å…ˆéƒ¨ç½²äº†å†è¯´ã€‚å“ªæœ‰ä»€ä¹ˆæå‡æ ‡å‡†ã€‚ç°åœ¨ä¸åº”è¯¥ä½¿åŠ²ç ”ç©¶è¿½ä¹å¤§å…µçš„è§†é¢‘äº†ã€‚

ç°åœ¨åº”è¯¥æŠŠé‡ç‚¹æ”¾åœ¨ç‹é‘«å®‡çš„ä»“åº“ä¸Šå•Šï¼Œéƒ¨ç½²æˆåŠŸä¸€ä¸ªï¼Œå°±å¼€å§‹å†™è¿™ä¸€éƒ¨åˆ†çš„è®ºæ–‡ã€‚
## è¯„ä¼°æŒ‡æ ‡
è¯„ä¼°YOLOæ¨¡å‹åœ¨PyTorchå’ŒTensorRTä¸‹çš„è¾“å‡ºå·®å¼‚é€šå¸¸æ¶‰åŠæ¯”è¾ƒæ¨¡å‹åœ¨ä¸¤ç§æ¡†æ¶ä¸‹çš„æ€§èƒ½å’Œç²¾åº¦ã€‚è¿™ç§æ¯”è¾ƒæœ‰åŠ©äºç¡®ä¿æ¨¡å‹è½¬æ¢è¿‡ç¨‹ï¼ˆä»PyTorchåˆ°TensorRTï¼‰æ²¡æœ‰å¼•å…¥æ˜¾è‘—è¯¯å·®ï¼ŒåŒæ—¶ä¿æŒæˆ–æå‡æ¨ç†é€Ÿåº¦ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…³é”®çš„è¯„ä¼°æŒ‡æ ‡ï¼š

1. ç²¾åº¦å·®å¼‚
IoUï¼ˆIntersection over Unionï¼‰ï¼šè¯„ä¼°é¢„æµ‹è¾¹ç•Œæ¡†ä¸çœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„é‡å ç¨‹åº¦ã€‚IoUçš„å€¼è¶Šé«˜ï¼Œè¡¨ç¤ºé¢„æµ‹è¶Šå‡†ç¡®ã€‚

mAPï¼ˆmean Average Precisionï¼‰ï¼šå¯¹äºæ£€æµ‹ä»»åŠ¡ï¼ŒmAPæ˜¯æœ€å¸¸ç”¨çš„è¯„ä¼°æŒ‡æ ‡ä¹‹ä¸€ã€‚å®ƒè®¡ç®—ä¸åŒé˜ˆå€¼ä¸‹çš„å¹³å‡ç²¾åº¦ï¼Œå¹¶å¯¹æ‰€æœ‰ç±»åˆ«å–å¹³å‡å€¼ã€‚æ¯”è¾ƒPyTorchå’ŒTensorRTæ¨¡å‹çš„mAPå¯ä»¥ç›´è§‚åœ°æ˜¾ç¤ºæ¨¡å‹æ€§èƒ½æ˜¯å¦åœ¨è½¬æ¢åæœ‰æ‰€ä¸‹é™ã€‚

2. æ€§èƒ½å·®å¼‚
æ¨ç†æ—¶é—´ï¼šè¡¡é‡æ¨¡å‹å®Œæˆä¸€æ¬¡æ¨ç†æ‰€éœ€çš„æ—¶é—´ã€‚TensorRTä¼˜åŒ–çš„ç›®æ ‡ä¹‹ä¸€å°±æ˜¯å‡å°‘æ¨¡å‹çš„æ¨ç†æ—¶é—´ï¼Œæé«˜å¤„ç†é€Ÿåº¦ã€‚

FPSï¼ˆFrames Per Secondï¼‰ï¼šæ¯ç§’å¯ä»¥å¤„ç†çš„å›¾åƒå¸§æ•°ã€‚é«˜FPSå€¼æ„å‘³ç€æ¨¡å‹å¯ä»¥æ›´å¿«åœ°å¤„ç†è¾“å…¥å›¾åƒï¼Œè¿™åœ¨å®æ—¶åº”ç”¨ä¸­å°¤ä¸ºé‡è¦ã€‚

3. èµ„æºä½¿ç”¨å·®å¼‚
GPU/CPUä½¿ç”¨ç‡ï¼šåœ¨æ¨ç†è¿‡ç¨‹ä¸­GPUå’ŒCPUçš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ä¸“é—¨çš„ç›‘æµ‹å·¥å…·æ¥è·Ÿè¸ªã€‚

å†…å­˜æ¶ˆè€—ï¼šæ¨ç†è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬GPUå’ŒCPUå†…å­˜ã€‚ä¼˜åŒ–çš„æ¨¡å‹åº”è¯¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨å†…å­˜ã€‚

è¯„ä¼°æ­¥éª¤
å‡†å¤‡ç›¸åŒçš„æ•°æ®é›†ï¼šç¡®ä¿PyTorchå’ŒTensorRTæ¨¡å‹ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ•°æ®é›†è¿›è¡Œè¯„ä¼°ã€‚

è¿è¡Œæ¨ç†ï¼šåœ¨ä¸¤ç§æ¡†æ¶ä¸‹è¿è¡Œæ¨¡å‹ï¼Œè®°å½•è¾“å‡ºç»“æœã€æ¨ç†æ—¶é—´ã€ä»¥åŠä»»ä½•å…¶ä»–ç›¸å…³çš„æ€§èƒ½æŒ‡æ ‡ã€‚

è®¡ç®—å·®å¼‚ï¼šä½¿ç”¨ä¸Šè¿°æŒ‡æ ‡æ¯”è¾ƒä¸¤ä¸ªæ¨¡å‹çš„è¾“å‡ºï¼Œè¯„ä¼°ç²¾åº¦å’Œæ€§èƒ½çš„å·®å¼‚ã€‚

ç»Ÿè®¡åˆ†æï¼šå¦‚æœæœ‰å¿…è¦ï¼Œè¿›è¡Œç»Ÿè®¡åˆ†ææ¥åˆ¤æ–­å·®å¼‚æ˜¯å¦å…·æœ‰ç»Ÿè®¡å­¦æ„ä¹‰ã€‚

æ³¨æ„äº‹é¡¹
ç¡®ä¿TensorRTä¼˜åŒ–åçš„æ¨¡å‹ä¿æŒåŸæœ‰ç»“æ„çš„å®Œæ•´æ€§ã€‚æœ‰æ—¶ï¼Œä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä¸€äº›è½¬æ¢å¯èƒ½ä¼šæ›´æ”¹æ¨¡å‹çš„éƒ¨åˆ†ç»†èŠ‚ï¼Œå¯èƒ½å¯¼è‡´ç²¾åº¦ä¸‹é™ã€‚

åœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œç¡®ä¿ä¸¤ä¸ªæ¨¡å‹éƒ½åœ¨ç›¸åŒçš„ç¡¬ä»¶å’Œè½¯ä»¶æ¡ä»¶ä¸‹è¿è¡Œã€‚

é€šè¿‡ç»¼åˆè€ƒè™‘è¿™äº›æŒ‡æ ‡å’Œè¯„ä¼°æ­¥éª¤ï¼Œä½ å¯ä»¥å…¨é¢åœ°äº†è§£æ¨¡å‹ä»PyTorchè½¬æ¢åˆ°TensorRTåçš„æ€§èƒ½å’Œç²¾åº¦å˜åŒ–ã€‚
## ç‹é‘«å®‡ä»“åº“
é¦–å…ˆæ‹‰æœ€æ–°çš„ä»“åº“ï¼Œç„¶åæŸ¥çœ‹æ‰€æœ‰yoloç³»åˆ—æ”¯æŒçš„tensorrtç‰ˆæœ¬ï¼Œå›ºå®šä¸€ä¸‹å„ç§è½¯ä»¶çš„ç‰ˆæœ¬ã€‚
tensorrt8æ¯”è¾ƒå¤šçš„è¯ï¼Œå°±éƒ½ç”¨8,ä¸ç„¶éƒ½ä¸åƒæ˜¯2024å¹´çš„è®ºæ–‡ã€‚
### yolovp
(base) /dataset01/zwc/tensorrtx/yolop/build (master âœ˜)âœ¹âœ­ á… ./yolop -d yolop.trt /dataset01/zwc/tensorrtx/yolop/YOLOP/inference/images
140ms
3ms
3ms
3ms
3ms
3ms
### yolov3
### yolov4
### yolov5
(base) /dataset01/zwc/tensorrtx/yolov5/tensorrtx/yolov5/build (yolov5-v7.0 âœ˜)âœ¹ á… ./yolov5_det -d yolov5s_det.engine ../images     
inference time: 122ms
inference time: 0ms

ç°åœ¨çš„é—®é¢˜ï¼Œyolov5sï¼Œéƒ¨ç½²åˆ°tensorrtä¸Šåï¼Œæ€ä¹ˆç”Ÿæˆresult.jsonæ–‡ä»¶å‘¢ï¼Ÿ


mAPval values are for single-model single-scale on COCO val2017 dataset.
#### yolov5s
(base) /dataset01/zwc/tensorrtx/yolov5/yolov5 (v7.0 âœ˜)âœ­ á… python val.py --save-json --data /dataset01/zwc/tensorrtx/yolov5/yolov5/data/coco.yaml   
val: data=/dataset01/zwc/tensorrtx/yolov5/yolov5/data/coco.yaml, weights=yolov5s.pt, batch_size=32, imgsz=640, conf_thres=0.001, iou_thres=0.6, max_det=300, task=val, device=, workers=8, single_cls=False, augment=False, verbose=False, save_txt=False, save_hybrid=False, save_conf=False, save_json=True, project=runs/val, name=exp, exist_ok=False, half=False, dnn=False
YOLOv5 ğŸš€ v7.0-0-g915bbf29 Python-3.9.13 torch-2.1.2+cu121 CUDA:0 (NVIDIA GeForce RTX 4090, 24217MiB)

Fusing layers... 
YOLOv5s summary: 213 layers, 7225885 parameters, 0 gradients, 16.4 GFLOPs
val: Scanning /dataset01/zwc/tensorrtx/yolov5/datasets/coco/val2017... 4952 images, 48 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5000/5000 00:00
val: New cache created: /dataset01/zwc/tensorrtx/yolov5/datasets/coco/val2017.cache
                 Class     Images  Instances          P          R      mAP50   mAP50-95: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 157/157 00:38
                   all       5000      36335       0.67       0.52      0.565      0.371
Speed: 0.1ms pre-process, 1.0ms inference, 1.2ms NMS per image at shape (32, 3, 640, 640)

Evaluating pycocotools mAP... saving runs/val/exp8/yolov5s_predictions.json...
loading annotations into memory...
Done (t=0.39s)
creating index...
index created!
Loading and preparing results...
DONE (t=4.81s)
creating index...
index created!
Running per image evaluation...
Evaluate annotation type *bbox*
DONE (t=53.68s).
Accumulating evaluation results...
DONE (t=11.77s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.374
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.571
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.402
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.211
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.423
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.490
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.311
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.516
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.566
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.378
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.625
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.723
Results saved to runs/val/exp8
### yolov6
ç‹é‘«å®‡æ²¡æœ‰yolov6ï¼Œè¿½ä¹æœ‰å•Šï¼ï¼æ²¡æœ‰åŠŸå¤«æ˜¯ç™½è´¹çš„ã€‚è€Œä¸”è¿½ä¹è¯¦ç»†ä¼˜åŒ–äº†yolov6ï¼Œä½†å°±æ˜¯æ²¡æœ‰ä»–é‚£ä¹ˆè€çš„æ˜¾å¡é…tensorrtäº†ã€‚

æ‰€ä»¥è¿˜æ˜¯æš‚æ—¶å…ˆæ”¾ä¸‹è¿™éƒ¨åˆ†ã€‚
### yolov7
### yolov8
### yolov9
2024å¹´3æœˆ11æ—¥ï¼Œçœ‹åˆ°ç¾¤é‡Œæœ‰äººå®Œæˆäº†yolov9ä¸¤ä¸ªå­æ¨¡å‹çš„éƒ¨ç½²,ç‰›é€¼ã€‚
# è¿½ä¹å¤§å…µçš„bç«™è§†é¢‘
## ç¯å¢ƒå®‰è£…æˆåŠŸ
```bash
docker pull nvcr.io/nvidia/tensorrt:22.12-py3
sudo docker run -it -d \
    --name mmyolo_trt8.5.1 \
    -v /dataset01:/dataset01 \
    --network="host" \
    --gpus all \
    nvcr.io/nvidia/tensorrt:22.12-py3

sudo docker exec -it mmyolo_trt8.5.1 /bin/bash

apt install ninja-build
apt-get install libgl1-mesa-glx
```
## p4 mmyoloåˆä½“éªŒ
### è®­ç»ƒ
```bash
sudo docker exec -it mmyolo_trt8.5.1 /bin/zsh
cd /dataset01/zwc/mmyolo-hb/mmyolo
python tools/train.py configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py
```
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.745
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.942
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.876
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = -1.000
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = -1.000
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.745
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.697
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.797
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.813
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = -1.000
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.813
03/06 14:13:12 - mmengine - INFO - bbox_mAP_copypaste: 0.745 0.942 0.876 -1.000 -1.000 0.745
03/06 14:13:12 - mmengine - INFO - Epoch(val) [40][28/28]    coco/bbox_mAP: 0.7450  coco/bbox_mAP_50: 0.9420  coco/bbox_mAP_75: 0.8760  coco/bbox_mAP_s: -1.0000  coco/bbox_mAP_m: -1.0000  coco/bbox_mAP_l: 0.7450  data_time: 0.0873  time: 0.1076
03/06 14:13:12 - mmengine - INFO - The previous best checkpoint /dataset01/zwc/mmyolo-hb/mmyolo/work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/best_coco_bbox_mAP_epoch_30.pth is removed
03/06 14:13:15 - mmengine - INFO - The best checkpoint with 0.7450 coco/bbox_mAP at 40 epoch is saved to best_coco_bbox_mAP_epoch_40.pth.
### å¯¼å‡ºonnx
```bash
python projects/easydeploy/tools/export.py \
    configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py \
    work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/epoch_40.pth \
    --work-dir work_dirs/yolov5_s-v61_fast_1xb12-40e_cat \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
    --opset 11 \
    --backend 1 \
    --pre-topk 1000 \
    --keep-topk 100 \
    --iou-threshold 0.65 \
    --score-threshold 0.25
```
ONNX export success, save into work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.onnx
### onnxç”¨cpuæ¨ç†
```bash
python projects/easydeploy/tools/image-demo.py \
    data/cat/images/IMG_20210728_205117.jpg \
    configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py \
    work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.onnx \
    --device cpu
# æ¨ç†ç»“æœåœ¨ä¸‹é¢ç›®å½•ï¼š
/dataset01/zwc/mmyolo-hb/mmyolo/output/IMG_20210728_205117.jpg
```
### å¯¼å‡º tensorrt8 éƒ¨ç½²éœ€è¦çš„onnx
```bash
python projects/easydeploy/tools/export.py \
    configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py \
    work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/epoch_40.pth \
    --work-dir work_dirs/yolov5_s-v61_fast_1xb12-40e_cat \
    --img-size 640 640 \
    --batch 1 \
    --device cuda:0 \
    --simplify \
    --opset 11 \
    --backend 2 \
    --pre-topk 1000 \
    --keep-topk 100 \
    --iou-threshold 0.65 \
    --score-threshold 0.25
```
ONNX export success, save into work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.onnx
### ç”¨è‹±ä¼Ÿè¾¾æ˜¾å¡ç”Ÿæˆåºåˆ—åŒ–æ–‡ä»¶
```bash
python projects/easydeploy/tools/build_engine.py \
    work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.onnx \
    --img-size 640 640 \
    --device cuda:0
```
Save in /dataset01/zwc/mmyolo-hb/mmyolo/work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.engine
### ç”¨è‹±ä¼Ÿè¾¾æ˜¾å¡è¿›è¡Œå›¾ç‰‡æ¨ç†
```bash
python projects/easydeploy/tools/image-demo.py \
    data/cat/images/IMG_20210728_205312.jpg \
    configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py \
    work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/end2end.engine \
    --device cuda:0
# æ¨ç†ç»“æœåœ¨ä¸‹é¢ç›®å½•ï¼š
/dataset01/zwc/mmyolo-hb/mmyolo/output/IMG_20210728_205312.jpg
```
## å¯¼å‡ºmmyoloç³»åˆ—æ¨¡å‹,onnx tensorrtç‰ˆæœ¬
### yolov5
å°±è¿˜æ˜¯ç”¨mmyoloåˆä½“éªŒä¸­ï¼ŒçŒ«æ£€æµ‹å™¨çš„è½¬æ¢å‘½ä»¤
```bash
python projects/easydeploy/tools/export.py \
	configs/yolov5/yolov5_s-v61_fast_1xb12-40e_cat.py \
	work_dirs/yolov5_s-v61_fast_1xb12-40e_cat/epoch_40.pth \
	--work-dir work_dirs/yolov5_s-v61_fast_1xb12-40e_cat \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### yolov6
```bash
pip install openmim==0.3.7
workdir="yolov6_n_syncbn_fast_8xb32-400e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir
pth_path=`ls ./work_dirs/$workdir/*.pth`

python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 30000 \
	--keep-topk 300 \
	--iou-threshold 0.65 \
	--score-threshold 0.001

netron work_dirs/yolov6_n_syncbn_fast_8xb32-400e_coco/end2end.onnx
ssh -L 8080:localhost:8080 student001@10.20.30.160
# backend 2 æ˜¯trt8, backend 3 æ˜¯trt7;
# yolov6 ç”¨trt8, æ£€æµ‹å¤´æ˜¯EfficientNMS_TRT; ç”¨ trt7 æ˜¯BatchedNMSDynamic_TRT;
```
### yolov7
```bash
workdir="yolov7_tiny_syncbn_fast_8x16b-300e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`

python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### yolov8
```bash
workdir="yolov8_n_syncbn_fast_8xb16-500e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`

python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### yolovx
```bash
workdir="yolox_tiny_fast_8xb8-300e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`
python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 3 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### ppyoloe_plus
```bash
workdir="ppyoloe_plus_s_fast_8xb8-80e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`
python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### rtmdet
```bash
workdir="rtmdet_tiny_syncbn_fast_8xb32-300e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`
python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
### rtmdet æ—‹è½¬æ¡†
```bash
workdir="rtmdet-r_tiny_fast_1xb8-36e_dota"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir


pth_path=`ls ./work_dirs/$workdir/*.pth`
python projects/easydeploy/tools/export.py \
	work_dirs/$workdir/$workdir.py \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 100 \
	--iou-threshold 0.65 \
	--score-threshold 0.25
```
è¿™ä¸ªå¯¼å‡ºæœ‰é—®é¢˜ã€‚
## åˆæ­¥å¯¼å‡ºTensorrt
```bash
workdir="yolov6_n_syncbn_fast_8xb32-400e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`

config_file="work_dirs/$workdir/$workdir.py"

python projects/easydeploy/tools/export.py \
	$config_file \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 1000 \
	--keep-topk 300 \
	--iou-threshold 0.65 \
	--score-threshold 0.3

python projects/easydeploy/tools/build_engine.py \
     ./work_dirs/$workdir/end2end.onnx \
    --img-size 640 640 \
    --device cuda:0

python projects/easydeploy/tools/image-demo.py \
    demo/dog.jpg \
    $config_file \
    ./work_dirs/$workdir/end2end.engine \
    --device cuda:0
```
## TensorRTæ¨¡å‹ç²¾åº¦çš„éªŒè¯
```bash
workdir="yolov6_n_syncbn_fast_8xb32-400e_coco"
mim download mmyolo --config $workdir --dest ./work_dirs/$workdir

pth_path=`ls ./work_dirs/$workdir/*.pth`

config_file="work_dirs/$workdir/$workdir.py"

python projects/easydeploy/tools/export.py \
	$config_file \
	${pth_path} \
	--work-dir work_dirs/$workdir \
    --img-size 640 640 \
    --batch 1 \
    --device cpu \
    --simplify \
	--opset 11 \
	--backend 2 \
	--pre-topk 30000 \
	--keep-topk 300 \
	--iou-threshold 0.65 \
	--score-threshold 0.001

python projects/easydeploy/tools/build_engine.py \
     ./work_dirs/$workdir/end2end.onnx \
    --img-size 640 640 \
    --device cuda:0

python self_study_scripts/01cmp_output_with_torch_tensorrt.py \
    demo/dog.jpg \
    $config_file \
    ./work_dirs/$workdir/end2end.engine \
    $pth_path \
    --device cuda:0

python self_study_scripts/01cmp_output_with_torch_tensorrt.py \
    /dataset01/coco2017/val2017/ \
    $config_file \
    ./work_dirs/$workdir/end2end.engine \
    $pth_path \
    --device cuda:0 \
	--result-json-path /dataset01/zwc/mmyolo-hb/mmyolo/self_study_scripts/tensort-1.json
è¿™ä¸ªå‘½ä»¤éœ€è¦å¾ˆä¹…ï¼Œè¦æ¨ç†5000ä¸ªå‘¢ã€‚
```
ç›®æ ‡ï¼š
1. æ¢ç´¢ç›¸åŒè¾“å…¥ä¸‹tensorrtå’Œpytorchä¸¤ä¸ªæ¡†æ¶çš„è¾“å‡ºæœ‰æ— ä¸åŒ
2. é’ˆå¯¹ coco-val æ•°æ®é›†ä¸‹çš„ç²¾åº¦ï¼Œtensorrtå’Œpytorchå¾—åˆ°çš„æœ‰ä½•åŒºåˆ«ï¼Ÿ

å¾—åˆ°yolov6 pytorchç‰ˆæœ¬è¾“å‡º

```bash
# æµ‹è¯•ç²¾åº¦ï¼Œ ä¸ºåŠ å¿«é€Ÿåº¦è¿˜è¯·å»æ‰'/dataset01/zwc/mmyolo-hb/mmyolo/work_dirs/yolov6_n_syncbn_fast_8xb32-400e_coco/yolov6_n_syncbn_fast_8xb32-400e_coco.py'æ–‡ä»¶ä¸­çš„ visualization hook
# visualization=dict(type='mmdet.DetVisualizationHook')
workdir="yolov6_n_syncbn_fast_8xb32-400e_coco"
pth_path=`ls ./work_dirs/$workdir/*.pth`
python tools/test.py work_dirs/$workdir/$workdir.py \
                     $pth_path \
					 --json-prefix ./self_study_scripts/yolov6_n_coco_result

python ./self_study_scripts/02evel_trt_json_output.py
```
ç¬¬ä¸€ä¸ªæ˜¯pytorchï¼Œç¬¬äºŒä¸ªæ˜¯tensorrt.
loading annotations into memory...
Done (t=0.50s)
creating index...
index created!
number of coco_classes: 80
Loading and preparing results...
DONE (t=12.20s)
creating index...
index created!
Running per image evaluation...
Evaluate annotation type *bbox*
DONE (t=106.48s).
Accumulating evaluation results...
DONE (t=26.75s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.362
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.516
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.392
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.166
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.401
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.521
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.312
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.522
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.574
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.340
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.644
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.773

Loading and preparing results...
DONE (t=5.28s)
creating index...
index created!
Running per image evaluation...
Evaluate annotation type *bbox*
DONE (t=107.03s).
Accumulating evaluation results...
DONE (t=26.48s).
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.361
 Average Precision  (AP) @[ IoU=0.50      | area=   all | maxDets=100 ] = 0.516
 Average Precision  (AP) @[ IoU=0.75      | area=   all | maxDets=100 ] = 0.389
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.167
 Average Precision  (AP) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.399
 Average Precision  (AP) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.519
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=  1 ] = 0.311
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets= 10 ] = 0.521
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=   all | maxDets=100 ] = 0.573
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= small | maxDets=100 ] = 0.338
 Average Recall     (AR) @[ IoU=0.50:0.95 | area=medium | maxDets=100 ] = 0.642
 Average Recall     (AR) @[ IoU=0.50:0.95 | area= large | maxDets=100 ] = 0.771
## ç²¾åº¦æ²¡æœ‰ç™¾åˆ†ä¹‹ç™¾å¯¹é½çš„åŸå› 
```bash
python demo/image_demo.py demo/dog.jpg ./work_dirs/yolov6_n_syncbn_fast_8xb32-400e_coco/yolov6_n_syncbn_fast_8xb32-400e_coco.py ./work_dirs/yolov6_n_syncbn_fast_8xb32-400e_coco/yolov6_n_syncbn_fast_8xb32-400e_coco_20221030_202726-d99b2e82.pth
```
å‡ºç°äº†ç‰ˆæœ¬å·®å¼‚å¯¼è‡´çš„é—®é¢˜ï¼Œåé¢çš„æ“ä½œéƒ½è·Ÿä¸ä¸Šäº†ã€‚è¿™ç§åˆ†æä¹Ÿå¹¶ä¸å¿…å†™åœ¨è®ºæ–‡é‡Œé¢ã€‚
# å¤ç°è®ºæ–‡
https://arxiv.org/abs/2204.06806

https://arxiv.org/pdf/2206.00820.pdf

https://github.com/ECoLab-POSTECH/NIPQ

https://zhuanlan.zhihu.com/p/651390746

äº¤å¤§çš„powerinfer

flexgen llm

https://zhuanlan.zhihu.com/p/664164593
## è®°å½•ä¸€äº›æƒ³çœ‹çš„ç½‘é¡µ
cmu catalystå›¢é˜Ÿå‡ºäº†llmæ¨ç†çš„ç»¼è¿°ï¼Œä½ å¯ä»¥ç®€å•ä»‹ç»ä¸€ä¸‹å—ï¼Ÿ
å¤§æ¨¡å‹å¦‚ä½•é«˜æ•ˆéƒ¨ç½²ï¼ŸCMUæœ€æ–°ä¸‡å­—ç»¼è¿°çºµè§ˆLLMæ¨ç†MLSysä¼˜åŒ–æŠ€æœ¯ - Hswordçš„æ–‡ç«  - çŸ¥ä¹
https://zhuanlan.zhihu.com/p/677635306

https://www.zhihu.com/question/637480772

https://docs.nvidia.com/deeplearning/tensorrt/pytorch-quantization-toolkit/docs/index.html

https://pytorch.org/blog/quantization-in-practice/#post-training-static-quantization-ptq

https://github.com/NVIDIA/TensorRT/tree/master/tools/pytorch-quantization

https://www.zhihu.com/question/411393222/answer/2359479242

https://www.cvmart.net/community?keyword=%E9%87%8F%E5%8C%96

https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg4ODA3MDkyMA==&action=getalbum&album_id=1648871870714200067&scene=173&from_msgid=2247483692&from_itemidx=1&count=3&nolastread=1#wechat_redirect

https://zhuanlan.zhihu.com/c_1258047709686231040

https://www.cnblogs.com/bigoldpan/p/16717472.html

https://www.cnblogs.com/bigoldpan/p/16328630.html

https://oldpan.me/archives/a-thought-of-oldpan

https://www.cnblogs.com/bigoldpan/p/16717472.html

https://oldpan.me/

https://www.cnblogs.com/bigoldpan/p/16296035.html

è®ºæ–‡
https://arxiv.org/abs/1712.05877?spm=ata.21736010.0.0.5d155919bwSdHC&file=1712.05877

mmdeploy

https://hanlab.mit.edu/songhan
# tips
## jupyteræµ‹è¯•ä»£ç†
```python
import requests

proxies = {
    "http": "http://127.0.0.1:7890",
    "https": "http://127.0.0.1:7890",
}
try:
    response = requests.get("https://www.google.com", proxies=proxies)
    print("Network connection is working.")
except requests.exceptions.RequestException as e: 
    print("Network connection is not working.")

```